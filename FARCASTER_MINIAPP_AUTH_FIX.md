# Farcaster Mini App 認証問題修正タスク

## 問題概要

Farcaster Mini App上でアプリにアクセスしてログインしても、最終的に`/signin`に戻されてしまう問題が発生している。

## 根本原因

1. **クッキー設定の問題**: Farcaster Mini App環境でのクッキー設定が適切でない
2. **認証状態の不整合**: Privy認証状態とクッキーベース認証状態の同期が不完全
3. **環境検出の不足**: Farcaster Mini App環境の適切な検出と対応が不十分

## 修正タスク一覧

### 1. 環境検出機能の実装

#### 1.1 Farcaster Mini App環境検出フックの作成
- **ファイル**: `src/hooks/useFarcasterEnvironment.ts`
- **内容**: Farcaster Mini App環境かどうかを判定するカスタムフック
- **判定方法**:
  - URLパラメータの確認
  - User-Agentの確認
  - Farcaster SDKコンテキストの確認

#### 1.2 環境判定ユーティリティの作成
- **ファイル**: `src/lib/environment.ts`
- **内容**: クライアントサイドとサーバーサイド両方で使用可能な環境判定関数

### 2. クッキー設定の修正

#### 2.1 環境別クッキー設定の実装
- **ファイル**: `src/lib/cookies.ts`
- **内容**: 環境に応じたクッキー設定関数
- **設定内容**:
  - Farcaster環境: `secure=false`, `samesite=lax`
  - 通常環境: `secure=true`, `samesite=strict`

#### 2.2 リフレッシュページの修正
- **ファイル**: `src/app/refresh/page.tsx`
- **修正内容**: 環境判定に基づくクッキー設定の適用

### 3. 認証状態の統合

#### 3.1 統合認証フックの作成
- **ファイル**: `src/hooks/useUnifiedAuth.ts`
- **内容**: Privy認証状態とクッキー認証状態を統合するフック
- **機能**:
  - 両方の認証状態の監視
  - 状態の同期
  - エラーハンドリング

#### 3.2 認証リダイレクトの修正
- **ファイル**: `src/components/features/auth/AuthRedirect.tsx`
- **修正内容**: 統合認証フックの使用とFarcaster環境への対応

### 4. ミドルウェアの改善

#### 4.1 認証チェックロジックの強化
- **ファイル**: `src/middleware.ts`
- **修正内容**:
  - Farcaster環境での認証チェック調整
  - より柔軟な認証状態判定
  - エラーハンドリングの改善

#### 4.2 環境別ルーティングの実装
- **内容**: Farcaster環境と通常環境での異なるルーティング処理

### 5. Farcaster Mini App統合の強化

#### 5.1 SDK初期化の改善
- **ファイル**: `src/hooks/useFarcasterMiniApp.ts`
- **修正内容**: より確実なSDK初期化とエラーハンドリング

#### 5.2 コンテキスト管理の改善
- **内容**: Farcasterコンテキストの適切な管理と認証状態との連携

## 実装順序

### Phase 1: 環境検出とクッキー設定
1. 環境検出フックの作成
2. クッキー設定ユーティリティの実装
3. リフレッシュページの修正

### Phase 2: 認証状態の統合
1. 統合認証フックの作成
2. AuthRedirectコンポーネントの修正
3. ミドルウェアの改善

### Phase 3: Farcaster統合の強化
1. SDK初期化の改善
2. コンテキスト管理の改善
3. テストとデバッグ

## 技術的な考慮事項

### セキュリティ
- Farcaster環境でのクッキーセキュリティ設定の調整
- クロスサイトリクエストの適切な処理

### パフォーマンス
- 認証状態チェックの最適化
- 不要なリダイレクトの削減

### 互換性
- 既存の認証フローとの互換性維持
- 異なる環境での動作保証

## テスト項目

### 1. 通常ブラウザ環境
- [ ] ログイン後の適切なリダイレクト
- [ ] クッキーの適切な設定
- [ ] セッション管理の動作

### 2. Farcaster Mini App環境
- [ ] ログイン後の適切なリダイレクト
- [ ] クッキーの適切な設定
- [ ] 認証状態の維持

### 3. エラーケース
- [ ] 認証失敗時の適切な処理
- [ ] ネットワークエラー時の処理
- [ ] トークン期限切れ時の処理

## 期待される結果

修正完了後、以下の動作が期待される：

1. **通常ブラウザ**: 既存と同様の認証フロー
2. **Farcaster Mini App**: ログイン後に適切に`/chat`に遷移
3. **認証状態**: 両環境で一貫した認証状態の管理
4. **エラーハンドリング**: 適切なエラー処理とユーザー体験の向上

## 注意事項

- 既存の認証フローを壊さないよう注意
- Farcaster環境でのセキュリティ設定の調整
- テスト環境での十分な検証
- 段階的な実装とテストの実施
